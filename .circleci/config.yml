version: 2.1

# Orbs for security scanning and deployment
orbs:
  node: circleci/node@5.1.0
  snyk: snyk/snyk@2.0.0
  sonarcloud: sonarsource/sonarcloud@2.0.0

# Define reusable executors
executors:
  node-executor:
    docker:
      - image: cimg/node:20.11.0
    working_directory: ~/project

# Reusable commands
commands:
  install-dependencies:
    description: "Install dependencies for backend and frontend"
    steps:
      - run:
          name: Install Backend Dependencies
          command: |
            cd backend
            npm ci
      - run:
          name: Install Frontend Dependencies
          command: |
            cd frontend
            npm ci

# Jobs definition
jobs:
  # Security: Dependency vulnerability scanning
  security-dependency-scan:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "backend/package-lock.json" }}-{{ checksum "frontend/package-lock.json" }}
            - v1-dependencies-
      - install-dependencies
      - run:
          name: Run npm audit on Backend
          command: |
            cd backend
            npm audit --audit-level=moderate || true
            npm audit --json > ../audit-backend.json || true
      - run:
          name: Run npm audit on Frontend
          command: |
            cd frontend
            npm audit --audit-level=moderate || true
            npm audit --json > ../audit-frontend.json || true
      - store_artifacts:
          path: audit-backend.json
      - store_artifacts:
          path: audit-frontend.json
      - save_cache:
          key: v1-dependencies-{{ checksum "backend/package-lock.json" }}-{{ checksum "frontend/package-lock.json" }}
          paths:
            - backend/node_modules
            - frontend/node_modules

  # Security: SAST (Static Application Security Testing)
  security-sast-scan:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "backend/package-lock.json" }}-{{ checksum "frontend/package-lock.json" }}
      - run:
          name: Install ESLint Security Plugin
          command: |
            cd backend
            npm install --save-dev eslint eslint-plugin-security || true
            cd ../frontend
            npm install --save-dev eslint eslint-plugin-security || true
      - run:
          name: Run ESLint Security Scan on Backend
          command: |
            cd backend
            npx eslint . --ext .js --format json --output-file ../eslint-backend.json || true
      - run:
          name: Run ESLint Security Scan on Frontend
          command: |
            cd frontend
            npx eslint . --ext .js,.jsx --format json --output-file ../eslint-frontend.json || true
      - store_artifacts:
          path: eslint-backend.json
      - store_artifacts:
          path: eslint-frontend.json

  # Security: Secret detection
  security-secret-scan:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Install Gitleaks
          command: |
            wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
            tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
            chmod +x gitleaks
      - run:
          name: Run Gitleaks Secret Scan
          command: |
            ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose || true
            if [ -f gitleaks-report.json ]; then
              echo "Gitleaks scan completed. Check artifacts for results."
            fi
      - store_artifacts:
          path: gitleaks-report.json

  # Code quality and linting
  code-quality:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "backend/package-lock.json" }}-{{ checksum "frontend/package-lock.json" }}
      - install-dependencies
      - run:
          name: Lint Backend Code
          command: |
            cd backend
            npx eslint . --ext .js || echo "Linting warnings found"
      - run:
          name: Lint Frontend Code
          command: |
            cd frontend
            npx eslint . --ext .js,.jsx || echo "Linting warnings found"

  # Unit tests for backend
  test-backend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "backend/package-lock.json" }}
      - run:
          name: Install Backend Dependencies
          command: |
            cd backend
            npm ci
      - run:
          name: Run Backend Tests
          command: |
            cd backend
            npm test || echo "No tests specified yet"
      - store_test_results:
          path: backend/test-results
      - store_artifacts:
          path: backend/coverage

  # Unit tests for frontend
  test-frontend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "frontend/package-lock.json" }}
      - run:
          name: Install Frontend Dependencies
          command: |
            cd frontend
            npm ci
      - run:
          name: Run Frontend Tests
          command: |
            cd frontend
            CI=true npm test -- --coverage --watchAll=false || true
      - store_test_results:
          path: frontend/test-results
      - store_artifacts:
          path: frontend/coverage

  # Build backend
  build-backend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "backend/package-lock.json" }}
      - run:
          name: Install Backend Dependencies
          command: |
            cd backend
            npm ci
      - run:
          name: Verify Backend Build
          command: |
            cd backend
            node -c server.js
            echo "Backend build verification successful"
      - persist_to_workspace:
          root: .
          paths:
            - backend

  # Build frontend
  build-frontend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "frontend/package-lock.json" }}
      - run:
          name: Install Frontend Dependencies
          command: |
            cd frontend
            npm ci
      - run:
          name: Build Frontend
          command: |
            cd frontend
            npm run build
      - persist_to_workspace:
          root: .
          paths:
            - frontend/build
      - store_artifacts:
          path: frontend/build

  # Container security scan 
  security-container-scan:
    docker:
      - image: aquasec/trivy:latest
    steps:
      - checkout
      - run:
          name: Scan filesystem for vulnerabilities
          command: |
            trivy fs --severity HIGH,CRITICAL --format json --output trivy-report.json . || true
      - store_artifacts:
          path: trivy-report.json

  # API Security Testing
  api-security-test:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "backend/package-lock.json" }}
      - run:
          name: Install Backend Dependencies
          command: |
            cd backend
            npm ci
      - run:
          name: Install API Testing Tools
          command: |
            cd backend
            npm install --save-dev supertest
      - run:
          name: Start Backend Server for Testing
          command: |
            cd backend
            npm start
          background: true
      - run:
          name: Wait for Server to Start
          command: |
            cd backend
            timeout 30 bash -c 'until curl -k -f https://localhost:4000/test; do sleep 1; done'
      - run:
          name: Run API Security Tests
          command: |
            cd backend
            npm run test:api || echo "API tests completed with warnings"
      - store_artifacts:
          path: backend/test-results

  # SonarQube Code Quality Analysis for Backend
  sonarqube-scan-backend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "backend/package-lock.json" }}
      - run:
          name: Install Backend Dependencies
          command: |
            cd backend
            npm ci
      - run:
          name: Generate Backend Test Coverage
          command: |
            cd backend
            npm test -- --coverage --coverageReporters=lcov || true
          no_output_timeout: 10m
      - run:
          name: Configure SonarQube for Backend
          command: |
            echo "sonar.projectKey=Younous87_InternationalPayment_Backend" > sonar-project.properties
            echo "sonar.organization=younous87" >> sonar-project.properties
            echo "sonar.projectName=International Payment System - Backend" >> sonar-project.properties
            echo "sonar.projectVersion=1.0" >> sonar-project.properties
            echo "sonar.sources=backend" >> sonar-project.properties
            echo "sonar.exclusions=**/node_modules/**,**/coverage/**,**/*.test.js,**/setupTests.js" >> sonar-project.properties
            echo "sonar.javascript.lcov.reportPaths=backend/coverage/lcov.info" >> sonar-project.properties
            echo "sonar.sourceEncoding=UTF-8" >> sonar-project.properties
            echo "sonar.javascript.file.suffixes=.js" >> sonar-project.properties
            echo "sonar.qualitygate.wait=true" >> sonar-project.properties
            echo "sonar.tests=backend/tests" >> sonar-project.properties
            echo "sonar.test.inclusions=**/*.test.js" >> sonar-project.properties
            echo "sonar.javascript.node.maxSpace=2048" >> sonar-project.properties
      - sonarcloud/scan:
          cache_version: 1
      - store_artifacts:
          path: .scannerwork
      - run:
          name: SonarQube Backend Quality Gate Check
          command: |
            echo "Backend SonarQube scan completed. Check SonarCloud dashboard for results."

  # SonarQube Code Quality Analysis for Frontend
  sonarqube-scan-frontend:
    executor: node-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "frontend/package-lock.json" }}
      - run:
          name: Install Frontend Dependencies
          command: |
            cd frontend
            npm ci
      - run:
          name: Generate Frontend Test Coverage
          command: |
            cd frontend
            CI=true npm test -- --coverage --coverageReporters=lcov --watchAll=false || true
          no_output_timeout: 10m
      - run:
          name: Configure SonarQube for Frontend
          command: |
            echo "sonar.projectKey=Younous87_InternationalPayment_Frontend" > sonar-project.properties
            echo "sonar.organization=younous87" >> sonar-project.properties
            echo "sonar.projectName=International Payment System - Frontend" >> sonar-project.properties
            echo "sonar.projectVersion=1.0" >> sonar-project.properties
            echo "sonar.sources=frontend/src" >> sonar-project.properties
            echo "sonar.exclusions=**/node_modules/**,**/build/**,**/coverage/**,**/*.test.js,**/*.test.jsx,**/setupTests.js" >> sonar-project.properties
            echo "sonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info" >> sonar-project.properties
            echo "sonar.sourceEncoding=UTF-8" >> sonar-project.properties
            echo "sonar.javascript.file.suffixes=.js,.jsx" >> sonar-project.properties
            echo "sonar.qualitygate.wait=true" >> sonar-project.properties
            echo "sonar.tests=frontend/src" >> sonar-project.properties
            echo "sonar.test.inclusions=**/*.test.js,**/*.test.jsx" >> sonar-project.properties
            echo "sonar.javascript.node.maxSpace=2048" >> sonar-project.properties
      - sonarcloud/scan:
          cache_version: 1
      - store_artifacts:
          path: .scannerwork
      - run:
          name: SonarQube Frontend Quality Gate Check
          command: |
            echo "Frontend SonarQube scan completed. Check SonarCloud dashboard for results."

  # Deployment approval gate
  deploy-approval:
    executor: node-executor
    steps:
      - run:
          name: Deployment Ready
          command: |
            echo "All security checks and tests passed!"
            echo "Ready for deployment approval."

# Workflows
workflows:
  version: 2
  devsecops-pipeline:
    jobs:
      # Security Scanning Phase (Parallel)
      - security-dependency-scan:
          filters:
            branches:
              only: /.*/
      
      - security-sast-scan:
          filters:
            branches:
              only: /.*/
      
      - security-secret-scan:
          filters:
            branches:
              only: /.*/
      
      - security-container-scan:
          filters:
            branches:
              only: /.*/
      
      # Code Quality Phase
      - code-quality:
          requires:
            - security-dependency-scan
          filters:
            branches:
              only: /.*/
      
      # Testing Phase (Parallel)
      - test-backend:
          requires:
            - code-quality
          filters:
            branches:
              only: /.*/
      
      - test-frontend:
          requires:
            - code-quality
          filters:
            branches:
              only: /.*/
      
      # Build Phase (Parallel)
      - build-backend:
          requires:
            - test-backend
            - security-sast-scan
            - security-secret-scan
          filters:
            branches:
              only: /.*/
      
      - build-frontend:
          requires:
            - test-frontend
            - security-sast-scan
            - security-secret-scan
          filters:
            branches:
              only: /.*/
      
      # API Security Testing
      - api-security-test:
          requires:
            - build-backend
          filters:
            branches:
              only: /.*/
      
      # SonarQube Code Quality Scan
      - sonarqube-scan-backend:
          requires:
            - api-security-test
          filters:
            branches:
              only: /.*/
      
      - sonarqube-scan-frontend:
          requires:
            - api-security-test
          filters:
            branches:
              only: /.*/
      
      # Deployment Approval
      - deploy-approval:
          type: approval
          requires:
            - sonarqube-scan-backend
            - sonarqube-scan-frontend
            - security-container-scan
          filters:
            branches:
              only:
                - main
                - master
                - Backend-Security

  # Scheduled security scans (weekly)
  scheduled-security-scan:
    triggers:
      - schedule:
          cron: "0 0 * * 0"  # Every Sunday at midnight
          filters:
            branches:
              only:
                - main
                - master
                - Backend-Security
    jobs:
      - security-dependency-scan
      - security-sast-scan
      - security-secret-scan
      - security-container-scan
      - api-security-test:
          requires:
            - security-dependency-scan
      - sonarqube-scan-backend:
          requires:
            - api-security-test
      - sonarqube-scan-frontend:
          requires:
            - api-security-test
